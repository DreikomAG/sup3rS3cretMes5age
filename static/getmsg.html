<!DOCTYPE html>
<html>
<head>
    <!--Let browser know website is optimized for mobile-->
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <!-- Facebook/Slack Meta Tags-->
    <meta content="Self Destructing Secure Message" property="og:title"/>
    <meta
            content="https://github.com/eranchetz/secretMsg"
            property="og:image"
    />
    <meta content="secureMsg" property="og:site_name"/>
    <meta
            content="A self destructing one time secure msg service, have fun, stay secure!"
            property="og:description"
    />
    <link href="/static/application.css" rel="stylesheet"/>
    <script
            integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3"
            src="/static/clipboard.min.js"
            type="text/javascript"
    ></script>
</head>

<body>
<header class="header">
    <div class="container">
        <a href="/msg">
            <img alt="Logo" class="logo" src="/static/img/logo.png">
        </a>
    </div>
</header>
<main class="send">
    <div class="container">
        <h1>Secret Message</h1>
        <p class="subtitle">Get your secret one-time read only message</p>
        <div class="input-field">
          <textarea
                  id="textarea1"
                  name="msg"
                  placeholder="Message should appear here"
                  readonly="true"
          ></textarea>
        </div>
        <div class="button">
            <button
                    class="btn clipboard"
                    data-clipboard-target="#textarea1"
                    name="action"
                    type="submit"
            >
                Copy to clipboard
            </button>
        </div>
    </div>
</main>
<footer class="footer">
    <a href="https://dreikom.ch" target="_blank">Infos</a>
</footer>

<script type="text/javascript">
    function domReady(fn) {
        document.addEventListener('DOMContentLoaded', fn);
        if (
            document.readyState === 'interactive' ||
            document.readyState === 'complete'
        ) {
            fn();
        }
    }

    domReady(function () {
        new Clipboard('.btn');

        const params = new URL(window.location).searchParams;

        console.log(
            window.location.origin +
            '/secret?token=' +
            params.get('token') +
            '&filetoken=' +
            params.get('filetoken') +
            '&filename=' +
            params.get('filename')
        );

        fetch('/secret?token=' + params.get('token'), {
            method: 'GET',
        })
            .then((res) => {
                if (!res.ok) {
                    throw new Error(res);
                }
                return res;
            })
            .then((res) => res.json())
            .then((data) => {
                console.log('Submission was successful.');
                console.log(data);
                showMsg(data.msg, params.get('filetoken'), params.get('filename'));
            })
            .catch((err) => {
                console.log('An error occurred.');
                console.log(err);
                showMsg('Message was already deleted :(');
            });
    });

    function showMsg(msg, filetoken, filename) {
        document.getElementById('textarea1').textContent = msg;
        if (filetoken) {
            console.log('filetoken=', filetoken);
            getSecret(filetoken, filename);
        }
    }

    function getSecret(token, name) {
        fetch('/secret?token=' + token, {
            method: 'GET',
        })
            .then((res) => res.json())
            .then((data) => {
                saveData(data.msg, name);
            })
            .catch((err) => {
                console.error(err);
            });
    }

    function saveData(data, fileName) {
        var a = document.createElement('a');
        document.body.appendChild(a);
        a.style = 'display: none';

        console.log('data=', data);
        console.log('fileName=', fileName);
        var blob = b64toBlob([data], {type: 'octet/stream'});
        url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = fileName;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function b64toBlob(b64Data, contentType, sliceSize) {
        sliceSize = sliceSize || 512;

        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (
            var offset = 0;
            offset < byteCharacters.length;
            offset += sliceSize
        ) {
            var slice = byteCharacters.slice(offset, offset + sliceSize);

            var byteNumbers = new Array(slice.length);
            for (var i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            var byteArray = new Uint8Array(byteNumbers);

            byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, {type: contentType});
    }
</script>
</body>
</html>
